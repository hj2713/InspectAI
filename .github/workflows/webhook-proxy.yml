# GitHub Actions workflow that proxies webhook events to Cloud Run via OIDC
#
# This workflow:
# 1. Triggers on issue_comment (for /InspectAI commands on PRs)
# 2. Authenticates to GCP using Workload Identity Federation (OIDC)
# 3. Calls the Cloud Run webhook endpoint with the event payload
#
# This bypasses the need for public access to Cloud Run!

name: Webhook Proxy to Cloud Run

on:
  issue_comment:
    types: [created]

env:
  CLOUD_RUN_URL: https://inspectai-webhook-285554595180.us-central1.run.app
  WORKLOAD_IDENTITY_PROVIDER: projects/285554595180/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-invoker@comse6998-479606.iam.gserviceaccount.com

jobs:
  proxy-webhook:
    name: Proxy Webhook to Cloud Run
    runs-on: ubuntu-latest
    
    # Only run if comment is on a PR and contains InspectAI command
    if: |
      github.event.issue.pull_request && 
      (contains(github.event.comment.body, '/InspectAI_review') ||
       contains(github.event.comment.body, '/inspectai_review') ||
       contains(github.event.comment.body, '/InspectAI_bugs') ||
       contains(github.event.comment.body, '/inspectai_bugs') ||
       contains(github.event.comment.body, '/InspectAI_refactor') ||
       contains(github.event.comment.body, '/inspectai_refactor'))
    
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      issues: write

    steps:
      - name: Log trigger info
        run: |
          echo "üîî InspectAI command detected!"
          echo "Comment: ${{ github.event.comment.body }}"
          echo "PR: #${{ github.event.issue.number }}"
          echo "Author: ${{ github.event.comment.user.login }}"
          echo "Repo: ${{ github.repository }}"

      - name: Authenticate to GCP via OIDC
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Call Cloud Run Webhook
        run: |
          # Get identity token for Cloud Run
          ID_TOKEN=$(gcloud auth print-identity-token --audiences="${{ env.CLOUD_RUN_URL }}")
          
          echo "üì§ Calling Cloud Run webhook..."
          echo "Token received: ${ID_TOKEN:0:20}..."
          
          # Construct the webhook payload matching GitHub's format
          # Using jq to properly escape the comment body
          COMMENT_BODY=$(echo '${{ github.event.comment.body }}' | jq -Rs .)
          
          PAYLOAD=$(jq -n \
            --argjson issue_number "${{ github.event.issue.number }}" \
            --arg pr_url "${{ github.event.issue.pull_request.url }}" \
            --arg comment_body "${{ github.event.comment.body }}" \
            --arg user_login "${{ github.event.comment.user.login }}" \
            --arg user_type "${{ github.event.comment.user.type }}" \
            --arg repo "${{ github.repository }}" \
            '{
              action: "created",
              issue: {
                number: $issue_number,
                pull_request: { url: $pr_url }
              },
              comment: {
                body: $comment_body,
                user: { login: $user_login, type: $user_type }
              },
              repository: { full_name: $repo },
              installation: { id: null }
            }')
          
          echo "Payload: ${PAYLOAD}"
          
          # Call the webhook endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ env.CLOUD_RUN_URL }}/webhooks/webhook/github" \
            -H "Authorization: Bearer ${ID_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: issue_comment" \
            -H "X-GitHub-Delivery: ${{ github.run_id }}" \
            -d "${PAYLOAD}")
          
          # Extract status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response Code: ${HTTP_CODE}"
          echo "Response Body: ${BODY}"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Webhook call successful!"
          else
            echo "‚ùå Webhook call failed with status ${HTTP_CODE}"
            exit 1
          fi

      - name: Post acknowledgment comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase();
            let command = 'review';
            if (comment.includes('bugs')) command = 'bugs';
            if (comment.includes('refactor')) command = 'refactor';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ü§ñ **InspectAI** is processing your \`${command}\` request...\n\n_This may take a moment._`
            });
