# GitHub Actions workflow for automatic deployment to Google Cloud Run
#
# This workflow:
# 1. Triggers on push to main branch
# 2. Builds a Docker image
# 3. Pushes to Google Artifact Registry
# 4. Deploys to Cloud Run
#
# Required GitHub Secrets (set in repo Settings > Secrets):
# - GCP_PROJECT_ID: Your Google Cloud project ID
# - GCP_SA_KEY: Service account JSON key (base64 encoded) - for deployment
# - GITHUB_APP_ID: Your GitHub App ID
# - GITHUB_APP_PRIVATE_KEY: Your GitHub App private key
# - GITHUB_WEBHOOK_SECRET: Your webhook secret
# - BYTEZ_API_KEY: Your Bytez API key
#
# OIDC Configuration (for secure webhook invocation):
# - Workload Identity Provider: projects/285554595180/locations/global/workloadIdentityPools/github-pool/providers/github-provider
# - Service Account: github-invoker@comse6998-479606.iam.gserviceaccount.com

name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
      - hj2713 # Also deploy from your branch for testing
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  SERVICE_NAME: inspectai-webhook
  IMAGE_NAME: inspectai-webhook
  WORKLOAD_IDENTITY_PROVIDER: projects/285554595180/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-invoker@comse6998-479606.iam.gserviceaccount.com

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: production  # Use secrets from this GitHub Environment
    
    # Required for OIDC authentication
    permissions:
      contents: read
      id-token: write

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Step 3: Set up Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Step 4: Enable APIs and Create Artifact Registry
      - name: Setup GCP Resources
        run: |
          gcloud services enable artifactregistry.googleapis.com --quiet
          gcloud services enable run.googleapis.com --quiet
          
          # Create Artifact Registry if it doesn't exist
          if ! gcloud artifacts repositories describe inspectai --location=${{ env.REGION }} &>/dev/null; then
            gcloud artifacts repositories create inspectai \
              --repository-format=docker \
              --location=${{ env.REGION }} \
              --description="InspectAI Docker images"
          fi

      # Step 5: Configure Docker for Artifact Registry
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # Step 6: Set up Docker Buildx for caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 7: Build and push Docker image with caching
      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/inspectai/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/inspectai/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Step 8: Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/inspectai/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --ingress=all \
            --set-env-vars "GITHUB_APP_ID=${{ secrets.APP_ID }}" \
            --set-env-vars "GITHUB_WEBHOOK_SECRET=${{ secrets.GITHUB_WEBHOOK_SECRET }}" \
            --set-env-vars "BYTEZ_API_KEY=${{ secrets.BYTEZ_API_KEY }}" \
            --set-env-vars "GITHUB_APP_PRIVATE_KEY=${{ secrets.APP_PRIVATE_KEY }}" \
            --memory 1Gi \
            --cpu 1 \
            --timeout 300 \
            --min-instances 0 \
            --max-instances 10

      # Step 9: Get and display the service URL
      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "üöÄ Service deployed successfully!"
          echo "üìç Service URL: $SERVICE_URL"
          echo "üîó Webhook URL: $SERVICE_URL/webhooks/webhook/github"
          echo ""
          echo "Update your GitHub App webhook URL to:"
          echo "$SERVICE_URL/webhooks/webhook/github"
